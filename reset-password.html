<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reset Password | ჩემი ქალაქი</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Use main style.css OR auth.css Bruh -->
  <link rel="stylesheet" href="auth.css">
</head>

<body class="auth-body">

  <div class="auth-card">
    <h2>პაროლის შეცვლა</h2>
    <p class="auth-subtitle">
      შეიყვანეთ ახალი პაროლი თქვენი ანგარიშისთვის
    </p>

    <input
      type="password"
      id="newPassword"
      placeholder="ახალი პაროლი"
    >

    <button id="resetBtn">
      პაროლის შეცვლა
    </button>

      <div class="back-home">
      <a href="index.html">← მთავარი გვერდი</a>
  </div>

    <p id="msg" class="auth-message"></p>
  </div>

  <!-- Status Modal -->
<div id="status-modal" class="status-modal">
    <div class="status-modal-content">
        <p id="status-msg" class="status-msg-text"></p>
        <button id="status-close" class="status-btn">გაგრძელება</button>
    </div>
</div>

  

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, confirmPasswordReset, verifyPasswordResetCode } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAXNVOlyzRhpVh7lJ6LC39ngr_D_98_Gak",
  authDomain: "mycityapp-b26e4.firebaseapp.com",
  projectId: "mycityapp-b26e4",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const params = new URLSearchParams(window.location.search);
const oobCode = params.get("oobCode");

const resetBtn = document.getElementById("resetBtn");
const newPasswordInput = document.getElementById("newPassword");

// Modal elements
const modal = document.getElementById("status-modal");
const modalMsg = document.getElementById("status-msg");
const modalClose = document.getElementById("status-close");

// --- Show modal helper ---
function showModal(message, redirect = true, delay = 3000) {
    modalMsg.textContent = message;
    modal.style.display = "flex";

    modalClose.onclick = () => {
        modal.style.display = "none";
        if (redirect) window.location.href = "login.html";
    };

    if (redirect) {
        setTimeout(() => window.location.href = "login.html", delay);
    }
}

// --- Check if link is missing/invalid/expired ---
if (!oobCode) {
    showModal("ბმული არასწორია ან ვადაგასულია.", true, 3000);
    resetBtn.disabled = true;
    newPasswordInput.disabled = true;
} else {
    verifyPasswordResetCode(auth, oobCode)
        .then(() => {
            // Link is valid → allow user to input new password
            resetBtn.disabled = false;
        })
        .catch(() => {
            // Link expired or already used
            showModal("ბმული ვადაგასულია ან უკვე გამოყენებულია.", true, 3000);
            resetBtn.disabled = true;
            newPasswordInput.disabled = true;
        });
}

// --- Handle password reset submission ---
resetBtn.onclick = async () => {
    const newPassword = newPasswordInput.value.trim();

    if (newPassword.length < 6) {
        showModal("პაროლი უნდა შეიცავდეს მინიმუმ 6 სიმბოლოს.", false);
        return;
    }

    try {
        await confirmPasswordReset(auth, oobCode, newPassword);

        // Success message + redirect
        showModal("✅ პაროლი წარმატებით შეიცვალა! გადაგიყვანთ შესვლის გვერდზე…", true, 3000);

        resetBtn.disabled = true;
        newPasswordInput.disabled = true;

    } catch (err) {
        // Catch invalid/expired code
        showModal("ბმული ვადაგასულია ან უკვე გამოყენებულია.", true, 3000);
        resetBtn.disabled = true;
        newPasswordInput.disabled = true;
    }
};
</script>

</body>
</html>
